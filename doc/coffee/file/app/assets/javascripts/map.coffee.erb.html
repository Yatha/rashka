<!DOCTYPE html>
<html>
  <head>
  <meta charset='UTF-8'>
  <title>CoffeeScript API Documentation</title>
  <script src='../../../../javascript/application.js'></script>
  <script src='../../../../javascript/search.js'></script>
  <link rel='stylesheet' href='../../../../stylesheets/application.css' type='text/css'>
</head>
  <body>
    <div id='base' data-path='../../../../'></div>
<div id='header'>
  <div id='menu'>
    <a href='../../../../extra/README.md.html' title='Rashka'>
      Rashka
    </a>
    &raquo;
    <a href='../../../../alphabetical_index.html' title='Index'>
      Index
    </a>
    &raquo;
    <span class='title'>app</span>
    &raquo;
    <span class='title'>assets</span>
    &raquo;
    <span class='title'>javascripts</span>
    &raquo;
    <span class='title'>map.coffee.erb</span>
  </div>
</div>
    <div id='content'>
      <h1>
        File:
        map.coffee.erb
      </h1>
      <table class='box'>
        <tr>
          <td>Defined in:</td>
          <td>app&#47;assets&#47;javascripts</td>
        </tr>
      </table>
      <h2>Variables Summary</h2>
      <dl class='constants'>
  <dt id='map-variable'>
    map
    =
  </dt>
  <dd>
    <pre><code class='coffeescript'>{
  dom: document.getElementById(&quot;map-canvas&quot;),
  last_valid_center: app.current_location,
  options: {
    center: app.current_location,
    disableDefaultUI: true,
    zoom: 13,
    minZoom: 4
  },
  current_marker: void 0,
  last_valid_center: void 0,
  bounds: void 0,
  markers: [],

  &#47;*
  Получает расстояние до каждой точки эвакуации и рисует их на карте
   *&#47;
  show_places: function() {
    app.places.objects.forEach(places.get_distance);
    return app.places.objects.forEach(places.render);
  },

  &#47;*
  Ставит маркер на координаты
  @param location [LatLng] координаты точки
   *&#47;
  set_current_location: function(location) {
    app.google_map.setCenter(location);
    app.current_location = location;
    return map.put_marker_on_current();
  },

  &#47;*
  В случае успеха определения местоположения юзера, обновляет карту
  @param location [LatLng] координаты местоположения юзера
   *&#47;
  nav_geo_success: function(location) {
    var current_location;
    map.current_marker.setMap(null);
    if (app.directions_renderer !== void 0) {
      app.directions_renderer.setMap(null);

      &#47;*
      TODO: ресетить кнопку валить, раз уж мы на всякий стираем маршрут
       *&#47;
    }
    current_location = new google.maps.LatLng(location.coords.latitude, location.coords.longitude);
    map.set_current_location(current_location);
    return map.reset_markers();
  },

  &#47;*
  В случае ошибки получения гео локации выводи лажу
   *&#47;
  nav_geo_error: function() {
    return console.log(&quot;Unable to retrieve your location&quot;);
  },

  &#47;*
  Спрашивает у пользователя его местоположение
   *&#47;
  get_current_location: function() {
    if (navigator.geolocation) {
      return navigator.geolocation.getCurrentPosition(map.nav_geo_success, map.nav_geo_error, {
        enableHighAccuracy: true
      });
    }
  },

  &#47;*
  Добавляет маркер с определенными параметрами к текущему месту
   *&#47;
  put_marker_on_current: function() {
    var current_loc_marker_options;
    current_loc_marker_options = {
      position: app.current_location,
      icon: &quot;&lt;%= asset_path(&#39;current.jpg&#39;) %&gt;&quot;,
      map: app.google_map
    };
    return map.current_marker = new google.maps.Marker(current_loc_marker_options);
  },

  &#47;*
  Обновляет маркеры для подготовки к новому текущему местоположению
   *&#47;
  reset_markers: function() {
    app.places.objects.forEach(places.get_distance);
    return app.places.objects.forEach(places.update_infobox);
  },

  &#47;*
  Проверяет, вышел ли пользователь за пределы границ карты. Передвигает в предыдущий &quot;чистый&quot; центер, если да, или записывает новый &quot;чистый&quot; центр
   *&#47;
  checkBounds: function() {
    if (map.bounds.contains(app.google_map.getCenter())) {
      map.last_valid_center = app.google_map.getCenter();
    }
    return app.google_map.panTo(map.last_valid_center);
  },

  &#47;*
  Группирует маркеры вместе в один, если они рядом
   *&#47;
  cluster_markers: function() {
    var markerCluster_styles;
    markerCluster_styles = [
      {
        url: &quot;&lt;%= asset_path(&#39;current.jpg&#39;) %&gt;&quot;,
        height: 35,
        width: 35,
        textSize: 1
      }
    ];
    return new MarkerClusterer(app.google_map, map.markers, {
      styles: markerCluster_styles
    });
  },

  &#47;*
  Инициализация карты и обозначение границ
   *&#47;
  init: function() {
    app.google_map = new google.maps.Map(this.dom, this.options);
    map.bounds = new google.maps.LatLngBounds(new google.maps.LatLng(41.2, 19.8), new google.maps.LatLng(77.792, 179.9999));
    return google.maps.event.addListener(app.google_map, &quot;center_changed&quot;, function() {
      return map.checkBounds();
    });
  }
}</code></pre>
    <div class='docstring'>
  <p>Параметры и функции карты</p>
</div>
<div class='tags'>
</div>
  </dd>
  <dt id='places-variable'>
    places
    =
  </dt>
  <dd>
    <pre><code class='coffeescript'>{
  types: {
    1: {
      icon: &quot;&lt;%= asset_path(&#39;places&#47;airplane.png&#39;) %&gt;&quot;
    },
    2: {
      icon: &quot;&lt;%= asset_path(&#39;places&#47;seaport.png&#39;) %&gt;&quot;
    },
    3: {
      icon: &quot;&lt;%= asset_path(&#39;places&#47;railway.png&#39;) %&gt;&quot;
    },
    4: {
      icon: &quot;&lt;%= asset_path(&#39;places&#47;border.png&#39;) %&gt;&quot;
    },
    5: {
      icon: &quot;&lt;%= asset_path(&#39;places&#47;car.png&#39;) %&gt;&quot;
    }
  },

  &#47;*
  Отображает место на карте: создает маркер для него
  @param place [Object] место
   *&#47;
  render: function(place) {
    var place_marker, place_marker_options, place_position;
    place_position = new google.maps.LatLng(place.lat, place.lng);
    place_marker_options = {
      position: place_position,
      map: app.google_map,
      icon: places.types[place.type_id].icon
    };
    place_marker = new google.maps.Marker(place_marker_options);
    map.markers.push(place_marker);
    return places.create_infobox(place, place_marker);
  },

  &#47;*
  Создает инфобокс для места
  @param place [Object] место
  @param place_marker [google.maps.Marker] маркер места
   *&#47;
  create_infobox: function(place, place_marker) {
    place.infobox = new InfoBox(app.infobox_options);
    places.update_infobox(place);
    google.maps.event.addListener(place_marker, &#39;mouseover&#39;, function() {
      return place.infobox.open(app.google_map, this);
    });
    return google.maps.event.addListener(place_marker, &#39;mouseout&#39;, function() {
      return place.infobox.close();
    });
  },

  &#47;*
  Устанавливает контент у инфобокса места
  @param place [Object] место
   *&#47;
  update_infobox: function(place) {
    var infobox_content;
    infobox_content = &quot;&lt;p&gt;&lt;b&gt;&quot; + place.type + &quot; :&lt;&#47;b&gt; &quot; + place.name + &quot; &lt;&#47;p&gt; &lt;p&gt;&lt;b&gt;Расстояние:&lt;&#47;b&gt; &quot; + (place.distance.toFixed(1)) + &quot; км&lt;&#47;p&gt;&quot;;
    return place.infobox.setContent(infobox_content);
  },

  &#47;*
  Перевод в радианы
  @param x [Integer] число
  @return [String] радианы
   *&#47;
  rad: function(x) {
    return x * Math.PI &#47; 180;
  },

  &#47;*
  Добавляет расстояние от места до текущего положения
  @param place [Object] место
   *&#47;
  get_distance: function(place) {
    var a, c, cur_loc_lat, cur_loc_lng, dLat, dLong, earth_radius, place_lat, place_lng;
    cur_loc_lat = app.current_location.lat();
    cur_loc_lng = app.current_location.lng();
    earth_radius = 6371;
    place_lat = place.lat;
    place_lng = place.lng;
    dLat = places.rad(place_lat - cur_loc_lat);
    dLong = places.rad(place_lng - cur_loc_lng);
    a = Math.sin(dLat &#47; 2) * Math.sin(dLat &#47; 2) + Math.cos(places.rad(cur_loc_lat)) * Math.cos(places.rad(cur_loc_lat)) * Math.sin(dLong &#47; 2) * Math.sin(dLong &#47; 2);
    c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    place.distance = earth_radius * c;
    return places.closest_check(place);
  },

  &#47;*
  Проверяет, является ли это место ближайшим к текущему и записывает, если да
  @param place [Object] место
   *&#47;
  closest_check: function(place) {
    if (app.places.closest === void 0 || app.places.closest.distance &gt; place.distance) {
      return app.places.closest = place;
    }
  }
}</code></pre>
    <div class='docstring'>
  <p>Параметры и функции мест</p>
</div>
<div class='tags'>
</div>
  </dd>
</dl>
    </div>
    <div id='footer'>
  February 18, 14 19:34:41 by
  <a href='https://github.com/coffeedoc/codo' title='CoffeeScript API documentation generator'>
    Codo
  </a>
  2.0.6
  &#10034;
  Press H to see the keyboard shortcuts
  &#10034;
  <a href='http://twitter.com/netzpirat' target='_parent'>@netzpirat</a>
  &#10034;
  <a href='http://twitter.com/_inossidabile' target='_parent'>@_inossidabile</a>
</div>
<iframe id='search_frame'></iframe>
<div id='fuzzySearch'>
  <input type='text'>
  <ol></ol>
</div>
<div id='help'>
  <p>
    Quickly fuzzy find classes, mixins, methods, file:
  </p>
  <ul>
    <li>
      <span>T</span>
      Open fuzzy finder dialog
    </li>
  </ul>
  <p>
    Control the navigation frame:
  </p>
  <ul>
    <li>
      <span>L</span>
      Toggle list view
    </li>
    <li>
      <span>C</span>
      Show class list
    </li>
    <li>
      <span>I</span>
      Show mixin list
    </li>
    <li>
      <span>F</span>
      Show file list
    </li>
    <li>
      <span>M</span>
      Show method list
    </li>
    <li>
      <span>E</span>
      Show extras list
    </li>
  </ul>
  <p>
    You can focus and blur the search input:
  </p>
  <ul>
    <li>
      <span>S</span>
      Focus search input
    </li>
    <li>
      <span>Esc</span>
      Blur search input
    </li>
  </ul>
</div>
  </body>
</html>